<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—…éŠé›²ç«¯æ‰“åŒ…æ¸…å–®</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary-color: #4a90e2;
            --bg-color: #f4f7f6;
            --card-bg: #ffffff;
        }
        body {
            font-family: "PingFang TC", "Microsoft JhengHei", sans-serif;
            background-color: var(--bg-color);
            margin: 0; padding: 20px;
            display: flex; flex-direction: column; align-items: center;
        }
        .header { text-align: center; margin-bottom: 30px; width: 100%; max-width: 600px; }
        .user-badge { background: #333; color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.9rem; }
        
        /* é€²åº¦æ¢æ¨£å¼ */
        .progress-container {
            width: 100%; background-color: #ddd; border-radius: 10px; margin: 15px 0; height: 20px; position: relative;
        }
        .progress-bar {
            width: 0%; height: 100%; background-color: #4caf50; border-radius: 10px; transition: width 0.3s;
        }
        .progress-text { position: absolute; width: 100%; text-align: center; font-size: 0.8rem; line-height: 20px; color: #000; font-weight: bold; }

        .container {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px; width: 100%; max-width: 1200px;
        }
        .category-card { background: var(--card-bg); border-radius: 12px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .input-group { display: flex; margin-bottom: 15px; gap: 5px; }
        input[type="text"] { flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        button.add-btn { padding: 8px 15px; background-color: var(--primary-color); color: white; border: none; border-radius: 4px; cursor: pointer; }
        ul { list-style: none; padding: 0; }
        li { display: flex; align-items: center; padding: 8px 0; border-bottom: 1px dashed #eee; }
        .delete-btn { color: #ff4d4f; cursor: pointer; margin-left: 10px; font-weight: bold; }
        .checked-text { text-decoration: line-through; color: #888; }
    </style>
</head>
<body>

    <div class="header">
        <h1>ğŸŒ æ—…éŠæ‰“åŒ…æ¸…å–® <span id="display-user" class="user-badge">è¼‰å…¥ä¸­...</span></h1>
        <div class="progress-container">
            <div class="progress-bar" id="progress-bar"></div>
            <div class="progress-text" id="progress-percent">ç¸½é«”é€²åº¦: 0%</div>
        </div>
        <p>åˆ‡æ›ä½¿ç”¨è€…ï¼š<a href="?user=Tony">Tony</a> | <a href="?user=Amy">Amy</a></p>
    </div>

    <div class="container">
        <div class="category-card"><h2>1. é‡è¦æ–‡ä»¶èˆ‡é‡‘è</h2><div class="input-group"><input type="text" id="input-list-1"><button class="add-btn" onclick="addItem('list-1')">æ–°å¢</button></div><ul id="list-1"></ul></div>
        <div class="category-card"><h2>2. è¡£ç‰©</h2><div class="input-group"><input type="text" id="input-list-2"><button class="add-btn" onclick="addItem('list-2')">æ–°å¢</button></div><ul id="list-2"></ul></div>
        <div class="category-card"><h2>3. å€‹äººè­·ç†èˆ‡è—¥å“</h2><div class="input-group"><input type="text" id="input-list-3"><button class="add-btn" onclick="addItem('list-3')">æ–°å¢</button></div><ul id="list-3"></ul></div>
        <div class="category-card"><h2>4. æ•¸ä½é›»å­èˆ‡é›œé …</h2><div class="input-group"><input type="text" id="input-list-4"><button class="add-btn" onclick="addItem('list-4')">æ–°å¢</button></div><ul id="list-4"></ul></div>
    </div>

    <script>
        const SUPABASE_URL = 'https://kxxoeebaldjusbberimg.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_y4SlLCg7DR5AnBzEkNUS-A_vIynlv5C';
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // å¾ç¶²å€è®€å–ä½¿ç”¨è€… (?user=Tony)ï¼Œé è¨­ç‚º Tony
        const urlParams = new URLSearchParams(window.location.search);
        const currentUser = urlParams.get('user') || 'Tony';
        document.getElementById('display-user').innerText = currentUser;

        window.onload = loadData;

        async function loadData() {
            // æ¸…ç©ºç•«é¢
            document.querySelectorAll('ul').forEach(el => el.innerHTML = '');
            
            const { data, error } = await _supabase
                .from('travel_items')
                .select('*')
                .eq('user_name', currentUser) // é—œéµï¼šåªæŠ“å–ç›®å‰ä½¿ç”¨è€…çš„è³‡æ–™
                .order('id', { ascending: true });

            if (data) {
                data.forEach(item => renderItemUI(item.category, item.content, item.is_checked, item.id));
                updateProgress();
            }
        }

        async function addItem(listId) {
            const input = document.getElementById('input-' + listId);
            const text = input.value.trim();
            if (!text) return;

            const { data, error } = await _supabase
                .from('travel_items')
                .insert([{ category: listId, content: text, is_checked: false, user_name: currentUser }])
                .select();

            if (data) {
                renderItemUI(listId, text, false, data[0].id);
                input.value = "";
                updateProgress();
            }
        }

        async function toggleCheck(id, isChecked) {
            const label = document.querySelector(`label[for="item-${id}"]`);
            isChecked ? label.classList.add('checked-text') : label.classList.remove('checked-text');

            await _supabase.from('travel_items').update({ is_checked: isChecked }).eq('id', id);
            updateProgress();
        }

        async function deleteItem(id, element) {
            const { error } = await _supabase.from('travel_items').delete().eq('id', id);
            if (!error) {
                element.parentElement.remove();
                updateProgress();
            }
        }

        function updateProgress() {
            const checkboxes = document.querySelectorAll('input[type="checkbox"]');
            const checked = document.querySelectorAll('input[type="checkbox"]:checked');
            const percent = checkboxes.length === 0 ? 0 : Math.round((checked.length / checkboxes.length) * 100);
            
            document.getElementById('progress-bar').style.width = percent + '%';
            document.getElementById('progress-percent').innerText = `ç¸½é«”é€²åº¦: ${percent}% (${checked.length}/${checkboxes.length})`;
        }

        function renderItemUI(listId, text, isChecked, id) {
            const list = document.getElementById(listId);
            const li = document.createElement('li');
            li.innerHTML = `
                <input type="checkbox" id="item-${id}" ${isChecked ? 'checked' : ''} onchange="toggleCheck(${id}, this.checked)">
                <label for="item-${id}" class="${isChecked ? 'checked-text' : ''}">${text}</label>
                <span class="delete-btn" onclick="deleteItem(${id}, this)">Ã—</span>
            `;
            list.appendChild(li);
        }
    </script>
</body>
</html>