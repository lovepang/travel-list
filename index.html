<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>âœˆï¸ æ¼«æ­¥é›²ç«¯ - æ—…éŠåŠ©æ‰‹</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&family=Noto+Sans+TC:wght@300;500;700&display=swap');

        :root {
            --primary: #5d9ead;
            --accent: #d98c5f;
            --shopping-bg: #fffbf2;
            --white: rgba(255, 255, 255, 0.92);
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: linear-gradient(rgba(0,0,0,0.3), rgba(0,0,0,0.3)), 
                        url('https://images.unsplash.com/photo-1488646953014-85cb44e25828?auto=format&fit=crop&w=1600&q=80');
            background-size: cover; background-attachment: fixed; background-position: center;
            margin: 0; padding: 20px; color: #2c3e50; min-height: 100vh;
        }

        /* æ¨™é¡Œèˆ‡ä½¿ç”¨è€…å€ */
        .header {
            text-align: center; max-width: 900px; margin: 0 auto 30px;
            background: var(--white); padding: 40px 20px; border-radius: 5px;
            box-shadow: 10px 10px 0px var(--primary); border: 2px solid #eee; position: relative;
        }

        #display-user { font-size: 3.5rem; color: var(--accent); font-family: 'Ma Shan Zheng', cursive; margin: 0; }

        .user-select { padding: 10px 20px; border: 2px solid var(--primary); background: transparent; color: var(--primary); font-weight: bold; cursor: pointer; }

        /* å¤©æ°£åŠ©æ‰‹å€å¡Š */
        .weather-box {
            background: rgba(255,255,255,0.7); border-radius: 10px; padding: 20px;
            margin: 20px 0; border: 1px dashed var(--primary); text-align: left;
        }
        .search-bar { display: flex; gap: 10px; margin-bottom: 10px; }
        .search-bar input { flex: 1; border: none; padding: 12px; border-bottom: 2px solid var(--primary); background: transparent; outline: none; }
        .location-tag { font-size: 0.8rem; color: var(--primary); margin-bottom: 10px; display: inline-block; background: #e0f2f1; padding: 2px 8px; border-radius: 4px; }

        /* å¡ç‰‡è¨­è¨ˆ */
        .container { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 25px; width: 100%; max-width: 1200px; margin: 0 auto; }
        .category-card { background: var(--white); padding: 25px; border-radius: 2px; box-shadow: 5px 5px 15px rgba(0,0,0,0.1); border-top: 5px solid var(--primary); }
        
        .shopping-section { grid-column: 1 / -1; margin-top: 40px; background: var(--shopping-bg); border: 3px solid var(--accent); border-radius: 15px; padding: 30px; }

        h2 { font-size: 1.25rem; margin: 0 0 15px; border-bottom: 1px solid #ddd; padding-bottom: 10px; display: flex; align-items: center; gap: 10px; }
        .input-group { display: flex; margin-bottom: 20px; }
        input[type="text"] { flex: 1; padding: 10px; border: 1px solid #eee; }
        .add-btn { background: var(--primary); color: white; border: none; padding: 10px 20px; cursor: pointer; }
        
        ul { list-style: none; padding: 0; }
        li { display: flex; align-items: center; padding: 12px 0; border-bottom: 1px solid #f1f1f1; }
        .delete-btn { color: #ddd; cursor: pointer; margin-left: auto; font-size: 0.8rem; }
        .checked-text { text-decoration: line-through; color: #ccc; }

        .progress-wrap { width: 100%; height: 6px; background: #eee; margin: 20px 0; border-radius: 10px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--accent); transition: 0.5s; width: 0%; }
    </style>
</head>
<body>

    <div class="header">
        <span id="display-user">Tony</span>
        <h3 style="letter-spacing: 5px; color: #888;">TRAVEL CHECKLIST</h3>
        
        <select class="user-select" onchange="switchUser(this.value)" id="user-dropdown">
            <option value="Tony">èº«åˆ†ï¼šTony</option>
            <option value="Amy">èº«åˆ†ï¼šAmy</option>
        </select>

        <div class="progress-wrap"><div class="progress-fill" id="progress-fill"></div></div>
        <div id="progress-percent" style="font-size: 0.8rem; color: var(--primary);">æ‰“åŒ…é€²åº¦ï¼š0%</div>

        <div class="weather-box">
            <div id="location-status" class="location-tag">ğŸ›°ï¸ æ­£åœ¨å®šä½æ‚¨çš„ç›®å‰ä½ç½®...</div>
            <div class="search-bar">
                <input type="text" id="city-input" placeholder="æ‰‹å‹•æœå°‹ç›®çš„åœ° (å¦‚ï¼šå·´é»ã€Tokyo)">
                <button class="add-btn" onclick="getWeather()">æœå°‹</button>
            </div>
            <div id="weather-display" class="weather-info">
                <small style="color:#999">å…è¨±å®šä½æ¬Šé™ï¼Œæˆ‘å°‡ç‚ºæ‚¨æä¾›å³æ™‚å¤©æ°£...</small>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="category-card"><h2>ğŸ’³ é‡è¦æ–‡ä»¶èˆ‡é‡‘è</h2><div class="input-group"><input type="text" id="input-list-1"><button class="add-btn" onclick="addItem('list-1')">ï¼‹</button></div><ul id="list-1"></ul></div>
        <div class="category-card"><h2>ğŸ‘• è¡£ç‰©ç©¿æ­</h2><div class="input-group"><input type="text" id="input-list-2"><button class="add-btn" onclick="addItem('list-2')">ï¼‹</button></div><ul id="list-2"></ul></div>
        <div class="category-card"><h2>ğŸ§´ å€‹äººè­·ç†èˆ‡è—¥å“</h2><div class="input-group"><input type="text" id="input-list-3"><button class="add-btn" onclick="addItem('list-3')">ï¼‹</button></div><ul id="list-3"></ul></div>
        <div class="category-card"><h2>ğŸ”Œ æ•¸ä½é›»å­èˆ‡é›œé …</h2><div class="input-group"><input type="text" id="input-list-4"><button class="add-btn" onclick="addItem('list-4')">ï¼‹</button></div><ul id="list-4"></ul></div>
        <div class="category-card"><h2>ğŸ§³ æ”¶ç´èˆ‡å…¶ä»–é…ä»¶</h2><div class="input-group"><input type="text" id="input-list-6"><button class="add-btn" onclick="addItem('list-6')">ï¼‹</button></div><ul id="list-6"></ul></div>

        <div class="category-card shopping-section">
            <h2 style="color: var(--accent)">ğŸ›ï¸ ç•¶åœ°æ¡è³¼æ¸…å–®</h2>
            <div class="input-group">
                <input type="text" id="input-list-5" placeholder="æƒ³è²·ä»€éº¼ï¼Ÿä¾‹å¦‚ï¼šè—¥å¦ã€ç´€å¿µå“...">
                <button class="add-btn" style="background:var(--accent)" onclick="addItem('list-5')">åŠ å…¥</button>
            </div>
            <ul id="list-5" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 10px;"></ul>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://kxxoeebaldjusbberimg.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_y4SlLCg7DR5AnBzEkNUS-A_vIynlv5C';
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const urlParams = new URLSearchParams(window.location.search);
        const currentUser = urlParams.get('user') || 'Tony';
        document.getElementById('display-user').innerText = currentUser;
        document.getElementById('user-dropdown').value = currentUser;

        window.onload = () => {
            loadData();
            autoDetectLocation(); // å•Ÿå‹•è‡ªå‹•å®šä½
        };

        function switchUser(val) { window.location.href = `?user=${val}`; }

        // --- æ ¸å¿ƒå®šä½åŠŸèƒ½ ---
        function autoDetectLocation() {
            const status = document.getElementById('location-status');
            if (!navigator.geolocation) {
                status.innerText = "âŒ æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´å®šä½";
                return;
            }

            navigator.geolocation.getCurrentPosition(async (pos) => {
                const lat = pos.coords.latitude;
                const lon = pos.coords.longitude;
                status.innerText = "ğŸ“ å®šä½æˆåŠŸï¼Œæ­£åœ¨ç²å–å¤©æ°£...";
                fetchWeather(lat, lon, "ç›®å‰ä½ç½®");
            }, (err) => {
                status.innerText = "â„¹ï¸ å®šä½æœªé–‹å•Ÿï¼Œæ‚¨å¯ä»¥æ‰‹å‹•è¼¸å…¥åŸå¸‚";
            });
        }

        async function fetchWeather(lat, lon, cityName) {
            const display = document.getElementById('weather-display');
            try {
                // å¦‚æœæ˜¯è‡ªå‹•å®šä½ï¼Œé †ä¾¿åæŸ¥åœ°å (ä½¿ç”¨ BigDataCloud å…è²» API)
                let finalName = cityName;
                if (cityName === "ç›®å‰ä½ç½®") {
                    const geoRes = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lon}&localityLanguage=zh`);
                    const geoData = await geoRes.json();
                    finalName = geoData.city || geoData.locality || "ç›®å‰ä½ç½®";
                }

                const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=weathercode,temperature_2m_max,temperature_2m_min&timezone=auto`);
                const data = await res.json();
                
                const minT = data.daily.temperature_2m_min[0];
                const maxT = data.daily.temperature_2m_max[0];
                let advice = minT < 12 ? "ğŸ§¥ å†·ï¼ç™¼ç†±è¡£+å¤§è¡£ã€‚" : minT < 20 ? "ğŸ§£ æ¶¼ã€‚é•·è¢–+è–„å¤–å¥—ã€‚" : "â˜€ï¸ ç†±ã€‚çŸ­è¢–é˜²æ›¬ã€‚";
                
                display.innerHTML = `<div><b style="color:var(--primary)">ğŸ“ ${finalName}</b>ï¼š${minT}~${maxT}Â°C <br><small>${advice}</small></div>`;
                document.getElementById('location-status').innerText = `ğŸŒ åµæ¸¬åˆ°æ‚¨åœ¨ï¼š${finalName}`;
            } catch (e) {
                display.innerText = "å¤©æ°£è¼‰å…¥å¤±æ•—";
            }
        }

        async function getWeather() {
            const city = document.getElementById('city-input').value;
            if (!city) return;
            try {
                const geo = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(city)}&count=1&language=zh&format=json`);
                const data = await geo.json();
                if (data.results) fetchWeather(data.results[0].latitude, data.results[0].longitude, data.results[0].name);
            } catch (e) { alert("æ‰¾ä¸åˆ°è©²åŸå¸‚"); }
        }

        // --- Supabase è³‡æ–™è™•ç† (åŒå‰) ---
        async function loadData() {
            document.querySelectorAll('ul').forEach(el => el.innerHTML = '');
            const { data } = await _supabase.from('travel_items').select('*').eq('user_name', currentUser).order('id', { ascending: true });
            if (data) { data.forEach(item => renderItemUI(item.category, item.content, item.is_checked, item.id)); updateProgress(); }
        }
        async function addItem(listId) {
            const input = document.getElementById('input-' + listId);
            const text = input.value.trim();
            if (!text) return;
            const { data } = await _supabase.from('travel_items').insert([{ category: listId, content: text, is_checked: false, user_name: currentUser }]).select();
            if (data) { renderItemUI(listId, text, false, data[0].id); input.value = ""; updateProgress(); }
        }
        async function toggleCheck(id, isChecked) {
            await _supabase.from('travel_items').update({ is_checked: isChecked }).eq('id', id);
            updateProgress();
        }
        async function deleteItem(id, element) {
            await _supabase.from('travel_items').delete().eq('id', id);
            element.parentElement.remove();
            updateProgress();
        }
        function updateProgress() {
            const total = document.querySelectorAll('input[type="checkbox"]').length;
            const checked = document.querySelectorAll('input[type="checkbox"]:checked').length;
            const percent = total === 0 ? 0 : Math.round((checked / total) * 100);
            document.getElementById('progress-fill').style.width = percent + '%';
            document.getElementById('progress-percent').innerText = `æ‰“åŒ…é€²åº¦ï¼š${percent}% (${checked}/${total})`;
        }
        function renderItemUI(listId, text, isChecked, id) {
            const list = document.getElementById(listId);
            if (!list) return;
            const li = document.createElement('li');
            li.innerHTML = `<input type="checkbox" id="item-${id}" ${isChecked ? 'checked' : ''} onchange="toggleCheck(${id}, this.checked)">
                <label for="item-${id}" class="${isChecked ? 'checked-text' : ''}" style="margin-left:15px; flex:1; cursor:pointer">${text}</label>
                <span class="delete-btn" onclick="deleteItem(${id}, this)">ğŸ—‘ï¸</span>`;
            list.appendChild(li);
        }
    </script>
</body>
</html>