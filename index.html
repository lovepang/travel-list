<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>âœˆï¸ æ¼«æ­¥é›²ç«¯ - æ—…éŠæ‰“åŒ…æ¸…å–®</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&family=Noto+Sans+TC:wght@300;500;700&display=swap');
        
        :root { 
            --primary: #5d9ead; 
            --accent: #e67e22; 
            --shopping-bg: #fffbf2; 
            --white: rgba(255, 255, 255, 0.94); 
        }

        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            background-color: #f4f1ea;
            /* âœ¨ æ›´æ›ç‚ºæ—…éŠå¡é€šé¢¨æ ¼èƒŒæ™¯ âœ¨ */
            background-image: linear-gradient(rgba(255,255,255,0.1), rgba(255,255,255,0.1)), url('https://images.unsplash.com/photo-1530789252389-121cd4387371?auto=format&fit=crop&w=1920&q=80'); 
            background-size: cover; 
            background-attachment: fixed; 
            background-position: center; 
            margin: 0; padding: 20px; color: #2c3e50; min-height: 100vh; 
        }

        .header { 
            text-align: center; max-width: 900px; margin: 0 auto 30px; 
            background: var(--white); padding: 45px 25px; border-radius: 12px; 
            box-shadow: 15px 15px 0px var(--primary); border: 1px solid #ddd; 
        }

        #display-user { 
            font-size: 5rem; color: var(--accent); font-family: 'Ma Shan Zheng', cursive; margin: 0; 
            text-shadow: 4px 4px 0px rgba(93, 158, 173, 0.2); letter-spacing: 10px; line-height: 1; margin-bottom: 5px;
        }

        /* âœ¨ åŠ å¤§å¾Œçš„æ¨™é¡Œæ¨£å¼ âœ¨ */
        .sub-title { 
            letter-spacing: 4px; 
            color: #5d9ead; 
            font-weight: 700; 
            font-size: 2.2rem; 
            margin-bottom: 25px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.05);
        }

        .user-select { padding: 10px 20px; border: 2px solid var(--primary); background: #fff; color: var(--primary); font-weight: bold; cursor: pointer; border-radius: 20px; font-size: 1rem; margin-top: 10px; }

        .progress-wrap { width: 80%; height: 16px; background: #e0e0e0; margin: 25px auto 10px; border-radius: 20px; overflow: hidden; border: 2px solid #fff; box-shadow: inset 0 2px 5px rgba(0,0,0,0.1); }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #5d9ead, #a8dadc, #5d9ead); background-size: 200% 100%; animation: move-stripe 3s linear infinite; width: 0%; transition: width 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275); position: relative; }

        @keyframes move-stripe { 0% { background-position: 0 0; } 100% { background-position: 100% 0; } }

        .weather-box { background: rgba(255,255,255,0.92); border-radius: 15px; padding: 20px; margin: 20px 0; border: 2px solid #fff; text-align: left; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .location-tag { font-size: 0.9rem; font-weight: bold; color: #fff; background: var(--primary); padding: 4px 12px; border-radius: 50px; display: inline-block; margin-bottom: 12px; }
        .search-bar { display: flex; gap: 8px; margin-bottom: 15px; }
        .search-bar input { flex: 1; border: 2px solid #eee; padding: 12px; border-radius: 8px; outline: none; }
        .temp-range { font-size: 1.8rem; font-weight: 700; color: var(--primary); }
        .advice-box { background: #fff; padding: 15px; border-radius: 10px; border-left: 5px solid var(--accent); margin-top: 10px; line-height: 1.6; }

        .container { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 25px; width: 100%; max-width: 1200px; margin: 0 auto; }
        .category-card { background: var(--white); padding: 25px; border-radius: 8px; box-shadow: 5px 5px 15px rgba(0,0,0,0.1); border-top: 6px solid var(--primary); }
        .shopping-section { grid-column: 1 / -1; margin-top: 40px; background: var(--shopping-bg); border: 3px solid var(--accent); border-radius: 20px; }
        
        .add-btn { background: var(--primary); color: white; border: none; padding: 10px 20px; cursor: pointer; border-radius: 5px; font-weight: bold; }
        ul { list-style: none; padding: 0; min-height: 60px; }
        li { display: flex; align-items: center; padding: 14px 0; border-bottom: 1px dashed #eee; cursor: grab; }
        .checked-text { text-decoration: line-through; color: #bbb; }
        .delete-btn { color: #ccc; cursor: pointer; margin-left: auto; }
    </style>
</head>
<body>

    <div class="header">
        <span id="display-user">Tony</span>
        <div class="sub-title">æ—…éŠæ‰“åŒ…æ¸…å–®</div>
        <select class="user-select" onchange="switchUser(this.value)" id="user-dropdown">
            <option value="Tony">Explorer: Tony</option>
            <option value="Amy">Explorer: Amy</option>
            <option value="Lucky">Explorer: Lucky</option>
            <option value="Cindy">Explorer: Cindy</option>
        </select>
        <div class="progress-wrap"><div class="progress-fill" id="progress-fill"></div></div>
        <div id="progress-percent" style="font-weight:bold; color:var(--primary)">0% æ‰“åŒ…å®Œæˆ</div>

        <div class="weather-box">
            <div id="location-status" class="location-tag">ğŸ›°ï¸ ä½ç½®æ¢æ¸¬ä¸­...</div>
            <div class="search-bar">
                <input type="text" id="city-input" placeholder="è¦å»å“ªå€‹åŸå¸‚å†’éšªï¼Ÿ">
                <button class="add-btn" onclick="searchWeather()">æŸ¥çœ‹å¤©æ°£</button>
            </div>
            <div id="weather-display" class="weather-info">è«‹è¼¸å…¥åŸå¸‚ä»¥æŸ¥çœ‹å°ˆå±¬ç©¿æ­å»ºè­°...</div>
        </div>
    </div>

    <div class="container">
        <div class="category-card"><h2>ğŸ’³ é‡è¦æ–‡ä»¶èˆ‡é‡‘è</h2><div class="input-group"><input type="text" id="input-list-1"><button class="add-btn" onclick="addItem('list-1')">ï¼‹</button></div><ul id="list-1"></ul></div>
        <div class="category-card"><h2>ğŸ‘• è¡£ç‰©ç©¿æ­</h2><div class="input-group"><input type="text" id="input-list-2"><button class="add-btn" onclick="addItem('list-2')">ï¼‹</button></div><ul id="list-2"></ul></div>
        <div class="category-card"><h2>ğŸ§´ å€‹äººè­·ç†èˆ‡è—¥å“</h2><div class="input-group"><input type="text" id="input-list-3"><button class="add-btn" onclick="addItem('list-3')">ï¼‹</button></div><ul id="list-3"></ul></div>
        <div class="category-card"><h2>ğŸ”Œ æ•¸ä½é›»å­èˆ‡é›œé …</h2><div class="input-group"><input type="text" id="input-list-4"><button class="add-btn" onclick="addItem('list-4')">ï¼‹</button></div><ul id="list-4"></ul></div>
        <div class="category-card"><h2>ğŸ§³ æ”¶ç´èˆ‡å…¶ä»–é…ä»¶</h2><div class="input-group"><input type="text" id="input-list-6"><button class="add-btn" onclick="addItem('list-6')">ï¼‹</button></div><ul id="list-6"></ul></div>
        <div class="category-card shopping-section">
            <h2 style="color: var(--accent)">ğŸ›ï¸ ç•¶åœ°æ¡è³¼ä»»å‹™</h2>
            <div class="input-group"><input type="text" id="input-list-5" placeholder="æƒ³è²·ä»€éº¼ç´€å¿µå“å‘¢ï¼Ÿ"><button class="add-btn" style="background:var(--accent)" onclick="addItem('list-5')">åŠ å…¥æ¸…å–®</button></div>
            <ul id="list-5" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 10px;"></ul>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://kxxoeebaldjusbberimg.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_y4SlLCg7DR5AnBzEkNUS-A_vIynlv5C';
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        const urlParams = new URLSearchParams(window.location.search);
        const currentUser = urlParams.get('user') || 'Tony';
        document.getElementById('display-user').innerText = currentUser;
        document.getElementById('user-dropdown').value = currentUser;

        window.onload = () => { loadData(); autoDetectLocation(); initDragAndDrop(); };
        function switchUser(val) { window.location.href = `?user=${val}`; }

        const weatherMap = { 0: "æ™´æœ—", 1: "æ™´æ™‚å¤šé›²", 2: "å¤šé›²", 3: "é™°å¤©", 45: "éœ§", 51: "æ¯›æ¯›é›¨", 61: "å°é›¨", 63: "ä¸­é›¨", 65: "å¤§é›¨", 80: "é™£é›¨", 95: "é›·é™£é›¨" };

        async function searchWeather() {
            const city = document.getElementById('city-input').value;
            if (!city) return;
            const geo = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(city)}&count=1&language=zh&format=json`);
            const data = await geo.json();
            if (data.results) {
                const res = data.results[0];
                fetchFullWeather(res.latitude, res.longitude, res.name);
            }
        }

        async function fetchFullWeather(lat, lon, name) {
            const display = document.getElementById('weather-display');
            document.getElementById('location-status').innerText = `ğŸŒ å†’éšªåœ°é»ï¼š${name}`;
            try {
                const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=weathercode,temperature_2m_max,temperature_2m_min&timezone=auto`);
                const data = await res.json();
                const minT = data.daily.temperature_2m_min[0];
                const maxT = data.daily.temperature_2m_max[0];
                const cond = weatherMap[data.daily.weathercode[0]] || "å¤šé›²";
                
                let advice = "";
                if (minT < 0) {
                    advice = "ğŸ§Š **0Â°Cä»¥ä¸‹ (æ¥µåœ°)**ï¼šé‡è£å‚™ï¼åšç¾½çµ¨ã€ç™¼ç†±è¡£(æ¥µæš–)ã€æ¯›å…§è£¡è¤²ã€æ¯›å¸½æ‰‹å¥—ã€é˜²æ»‘é´ã€‚";
                } else if (minT >= 0 && minT < 5) {
                    advice = "â„ï¸ **0~5Â°C (å¯’å†·)**ï¼šåšç¾½çµ¨ + ç¾Šæ¯›è¡« + ç™¼ç†±è¡£ã€‚åœå·¾èˆ‡æš–æš–åŒ…å¿…å‚™ã€‚";
                } else if (minT >= 5 && minT < 10) {
                    advice = "ğŸ§¥ **5~10Â°C (å†¬æ—¥)**ï¼šé˜²é¢¨å¤§è¡£ + ç™¼ç†±è¡£ + æ¯›è¡£ï¼Œæ¡æ´‹è”¥å¼ç©¿æ³•ã€‚";
                } else if (minT >= 10 && minT < 18) {
                    advice = "ğŸ§£ **10~18Â°C (æ¶¼çˆ½)**ï¼šè¼•ç¾½çµ¨æˆ–é¢¨è¡£ + é•·è¢–ä¸Šè¡£ã€‚æ³¨æ„æ—©æ™šæº«å·®ã€‚";
                } else if (minT >= 18 && minT < 24) {
                    advice = "ğŸ‘• **18~24Â°C (èˆ’é©)**ï¼šè–„å¤–å¥— + çŸ­è¢–æˆ–é•·è¢–è–„è¥¯è¡«ã€‚";
                } else {
                    advice = "â˜€ï¸ **24Â°Cä»¥ä¸Š (ç‚ç†±)**ï¼šè¼•ä¾¿é€æ°£ã€æŠ—UVè¡£ç‰©ï¼Œæ³¨æ„é˜²æ›¬è£œæ°´ã€‚";
                }
                if ([61, 63, 65, 80, 95].includes(data.daily.weathercode[0])) advice += " â˜” **é›¨å¤©æé†’ï¼šè¨˜å¾—å¸¶å‚˜ï¼**";

                display.innerHTML = `<div class="temp-range">${minT}Â°C ~ ${maxT}Â°C <span style="font-size:1rem; color:#888">(${cond})</span></div><div class="advice-box"><strong>ğŸ’¡ å°ˆæ¥­ç©¿è‘—å»ºè­°ï¼š</strong><br>${advice}</div>`;
            } catch (e) { display.innerText = "æ°£è±¡ç²å–å¤±æ•—"; }
        }

        function autoDetectLocation() {
            if (!navigator.geolocation) return;
            navigator.geolocation.getCurrentPosition(async (pos) => {
                const { latitude: lat, longitude: lon } = pos.coords;
                const geo = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lon}&localityLanguage=zh`);
                const geoData = await geo.json();
                fetchFullWeather(lat, lon, geoData.city || "ç›®å‰ä½ç½®");
            });
        }

        function initDragAndDrop() {
            document.querySelectorAll('ul').forEach(el => {
                new Sortable(el, { group: 'travel-items', animation: 150, onEnd: async (evt) => {
                    const itemId = evt.item.querySelector('input').id.replace('item-', '');
                    await _supabase.from('travel_items').update({ category: evt.to.id }).eq('id', itemId);
                    updateProgress();
                }});
            });
        }

        async function loadData() {
            document.querySelectorAll('ul').forEach(el => el.innerHTML = '');
            const { data } = await _supabase.from('travel_items').select('*').eq('user_name', currentUser).order('id', { ascending: true });
            if (data) { data.forEach(item => renderItemUI(item.category, item.content, item.is_checked, item.id)); updateProgress(); }
        }

        async function addItem(listId) {
            const input = document.getElementById('input-' + listId);
            const text = input.value.trim(); if (!text) return;
            const { data } = await _supabase.from('travel_items').insert([{ category: listId, content: text, is_checked: false, user_name: currentUser }]).select();
            if (data) { renderItemUI(listId, text, false, data[0].id); input.value = ""; updateProgress(); }
        }

        async function toggleCheck(id, isChecked) { await _supabase.from('travel_items').update({ is_checked: isChecked }).eq('id', id); updateProgress(); }

        async function deleteItem(id, element) { await _supabase.from('travel_items').delete().eq('id', id); element.parentElement.remove(); updateProgress(); }

        function updateProgress() {
            const total = document.querySelectorAll('input[type="checkbox"]').length;
            const checked = document.querySelectorAll('input[type="checkbox"]:checked').length;
            const percent = total === 0 ? 0 : Math.round((checked / total) * 100);
            document.getElementById('progress-fill').style.width = percent + '%';
            document.getElementById('progress-percent').innerText = `${percent}% æ‰“åŒ…å®Œæˆ (${checked}/${total})`;
        }

        function renderItemUI(listId, text, isChecked, id) {
            const list = document.getElementById(listId); if (!list) return;
            const li = document.createElement('li');
            li.innerHTML = `<input type="checkbox" id="item-${id}" ${isChecked ? 'checked' : ''} onchange="toggleCheck(${id}, this.checked)">
                <label for="item-${id}" class="${isChecked ? 'checked-text' : ''}" style="margin-left:15px; flex:1; cursor:pointer">${text}</label>
                <span class="delete-btn" onclick="deleteItem(${id}, this)">ğŸ—‘ï¸</span>`;
            list.appendChild(li);
        }
    </script>
</body>
</html>